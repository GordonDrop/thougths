# Протоколы нижнего уровня

## Уровень сетевого интерфейса

Как мы помним нижний уровень объединяет:

- Канальный уровень. Передачи осмысл послед-ти байтов в одной канальной среде.
- Физический уровень. Уровень среды и сигнала.

Для передачи данных нужно знать целевой MAC-адрес, но этого недостаточно, так как нужно еще знать IP адрес в сети. Канальная и сетевая адресации работают в тесной связке между собой и по отдельности работать не смогут.

**Пример 1**, есть локальная сеть и одна канальная среда - неск компьютера, одни центр коммутатор. Отправляется сигнал на некий IP адрес, сначала его услышат все участники сети. Ответит нужный - у меня IP X и MAC-адрес Y.

Дальше нужно научиться отличать одну подсеть от другой, в одной подсети находятся узлы или в разных. Для этого на помощь приходит маска подсети.

Маска сети 255.255.255.0 - четыре октета, октет число 0-255.

Первые 3 октета (они фиксированы) показывают адрес сети, а 4 октет (он динамический) показывает адрес хоста.
Иными словами, данная маска показывает, что нужно проверять первые 3 октета полностью, а четвертый может быть свободным от 0 — 255.

Вернемся к примеру: мы отправили сигнал с устройства с MAC 111 и IP 1.1.1.1 на IP 1.1.1.4. Получили ответ с IP 1.1.1.4 и MAC: 444
Для определения в одной ли мы подсети нужно наложить маску подсети 255.255.255.0 на IP адрес получателя 1.1.1.4

1.1.1.1
1.1.1.4

Три первых октета одниковы => подсеть тоже.

*Пример 2* Получатель MAC:555 находиться в другой подсети, соединеной с данной с помощью роутера. Отправляем сигнал и получаем MAC:555 и IP:1.1.2.1, маска таже

1.1.1.1
1.1.2.1

Октеты разные - подсети тоже. Для решения таких ситуаций в настройках ОС есть основной шлюз. Он нужен для отправки данных в др канал среду.

## Шлюз

Для отправки данных в разные подсети(канальные среды) в настройках ОС есть основной шлюз. Он нужен для отправки данных в др канал среду.
В примере 2 шлюз это роутер.

Пример: адрес шлюза 1.1.1.254. IP 1.1.1.1 крикнет на всю сеть: «1.1.1.254 отзовись». Ответит маршрутизатор. 1.1.1.1 отошлет данные до 1.1.2.254. Причем обратите внимание. На канальном уровне данные будут отправлены на MAC:777, а на сетевом, на IP:1.1.2.1.

Т.е. MAC-адрес передается только в своей канальной среде, а сетевой адрес не меняется на всем своем пути. Когда маршрутизатор получит инфу, он поймет, что на канальном уровне она предназначалась ему, но когда увидит IP-адрес, то поймет, что он промежуточное звено и передать надо в другую канальную среду. Его второй порт смотрит в нужную подсеть. Значит, ему все пришло верно. Но он не знает MAC-адрес адресата. Он начинает так же кричать на всю сеть: «Кто такой 1.1.2.1?». И комп с MAC-адресом 555 отвечает ему.

## MAC-адрес

уникальный идентификатор сетевого устройства.

Размер - 48 бит. Первые 24 бита — это уникальный идентификатор организации(выдает IEEE). Вторые 24 бита назначаются производителем оборудования.

Уникальность MAC-адресов достигается тем, что каждый производитель получает в координирующем комитете IEEE Registration Authority диапазон из 16 777 216 (2^24) адресов и, по мере исчерпания выделенных адресов, может запросить новый диапазон. Поэтому по трём старшим байтам MAC-адреса можно определить производителя. Существуют таблицы, позволяющие определить производителя по MAC-адресу; в частности, они включены в программы типа arpalert.

Примеры:
```
1) 00-50-56-C0-00-08
2) 00:50:56:C0:00:08
3) 0050.56С0.0008
```

## Ethernet
- протокол на канальном уровне
- семейство протоколов пакетной передачи данных

IEEE описала его стандартом 802.3. Так что, все версии, которые начинаются с 802.3, относятся именно к нему. Например, 802.3z — это GigabitEthernet через волоконно-оптический кабель; 1 Гбит/с, а 802.3af — это электропитание через Ethernet (PoE — Power over Ethernet).

Существует много версий протокола, рассмотрим один из них.

Ethernet-кадр - фрагмент данных передаваемый на канальном уровне:

1) Преамбула. 8-байт. Поле, используемое для указания начала кадра. То есть, чтобы приемник смог понять, где начало нового кадра. Раньше, когда использовалась топология с общей шиной и были коллизии, преамбула помогала предотвращать коллизии.

2) MAC-адрес получателя. 6 байт

3) MAC-адрес отправителя. 6 байт

4) Тип (длина). 2байта. Раньше в этом поле указывалось, какому вышестоящему протоколу передается данный кадр, но в дальнейшем от этого отказались и ввели поле «Длина». Оно указывает длину поля данных.

5) Поле SNAP/LLC + данные. 46-1500 байт.Как раз SNAP/LLC указывает какому вышестоящему протоколу передать кадр: IP, IPX и др. Также в этом поле содержатся данные, полученные с высших уровней.

6) FCS (от англ. Frame Check Sequence — контрольная сумма кадра). Для проверки целостности кадра.

## IP

*IP* (от англ. Internet Protocol). Протокол семейства TCP/IP. Разработан в 80-х годах. Используется для объединения отдельных компьютерных сетей между собой.

Также важной его особенностью является адресация, которую называют **IP-адрес**.

**Версии**:

1) **IPv4.** Использует 32-битные адреса. Формат 4 октета с числами от 0 до 255. Например, адрес 192.168.0.4. Это самая популярная версия на сегодняшний день.

2) IPv6. Использует 128-битные адреса, которые записываются в формате восьми четырехзначных шестнадцатеричных чисел (от 0 до F). Например, 2001:0db8:11a3:09d7:1f34:8a2e:07a0:765d. Каждое число разделенное точками называют хекстетом. На заре всеобщей компьютеризации появилась проблема. Стали заканчиваться IP-адреса и нужен был новый протокол, который смог бы обеспечить больше адресов. Так и появился в 1996 году протокол IPv6. Но благодаря технологии NAT, была частична решена проблема нехватки адресов. Внедрение IPv6 затянулось по сегодняшний день.

IP работает с блоком информации, **IP-пакетом**. Его структура:

1) Версия. IPv4 или IPv6.

2) IHL (от англ. Internet Header Length — размер заголовка). Многие из показанных на картинке полей не фиксированы - это поле считает размер заголовка.

3) Тип обслуживания. Обслуживает размер очередей QoS (Quality of Service — качество обслуживания). Делает он это при помощи байта, который указывает на определенный набор критериев (требование ко времени задержки, пропускной способности, надежности и т.д.)

4) Длина пакета. Размер пакета. Если IHL отвечает только за размер полей в заголовке (заголовком являются все поля на картинке, кроме поля данных), то длина пакета отвечает за весь пакет в целом, включая пользовательские данные.

5) Время жизни (TTL- Time To Live). Поле, используемое для предотвращения циклического пути пакета. При прохождении через маршрутизатор, значение уменьшается на единицу, и когда достигает нуля, пакет отбрасывается.

6) Протокол. Вышестоящий протокол пакета (TCP, UDP).

7) Контрольная сумма заголовка. Для проверки целостности полей заголовка. Не данных! Данные проверяются соответствующим полем на канальном уровне.

8) Опции. Это поле используется для расширения стандартного заголовка IP. Используется в привычных сетях редко. Сюда записываются данные для какого-нибудь специфического оборудования, которое читает это поле. Например, система управления дверными замками (где идет общение с контроллером), технология умного дома, интернет-вещи и так далее. Привычные сетевые устройства, как роутеры и коммутаторы, будут игнорировать это поле.

9) Смещение. Указывает, какому месту принадлежит фрагмент в оригинальном IP. Это значение всегда кратно восьми байтам.

10) Данные. Данные, полученные с вышестоящих уровней. Чуть выше я показал, что в Ethernet-кадре тоже есть поле данных. И в его поле данных будет включен данный IP-пакет. Важно помнить, что максимальный размер Ethernet-кадра равен 1500 байт, а вот размер IP пакета может быть 20 Кбайт. Соответственно весь пакет не вместится в поле данных Ethernet-кадра. Поэтому пакет делят и отправляют частями. И вот для этого используются 3 поля ниже.

11) Идентификатор. Это 4-х байтовое число, которое показывает, что все части разделенного пакета одно единое целое.

12) Флаги. Указывает, что это не единый, а фрагментированный пакет.

13) Смещение фрагмента. Сдвиг относительно первого фрагмента. То есть это нумерация, которая поможет собрать IP-пакет воедино.

14) IP-адрес отправителя и IP-адрес получателя. Соответственно эти 2 поля указывают от кого и для кого пакет.

## UDP

Транспортный уровень предназначен для доставки данных определенному приложению, которое он определяет по номеру порта. Задачи зависят от протокола. Например, фрагментация файлов, контроль доставки, мультиплексирование потоками данных и управление ими.

Работа UDP — это указать номер порта и отправить. Что там будет происходить дальше, его не интересует. 

1) Порт источника. Порт, используемый клиентом или сервером для идентификации службы. На этот порт, при необходимости, будет посылаться ответ.

2) Порт назначения. Здесь указывается порт, который будет являться адресатом. Например, если клиент запрашивает страницу сайта, то порт назначения, по умолчанию, будет 80-ый (протокол HTTP).

3) Длина UDP. Длина заголовка UDP. Размер варьируется от 8 до 65535 байт. 

4) Контрольная сумма UDP. Проверка целостности. Если нарушена, то просто отбрасывает без запроса о повторной отправки.

5) Данные. Здесь упакованы данные с верхнего уровня. Например, когда веб-сервер отвечает на запрос клиента и отправляет веб-страницу, то она будет лежать в этом поле.

Задача UDP:  нумерация портов и проверка побился ли кадр. 

## TCP

1) Порт источника и порт назначения. Тоже что и UDP.

2) Порядковый номер. Номер, который используется для того, чтобы на другой стороне было понятно какой этот сегмент по счету.

3) Номер подтверждения. Это поле используется, когда ожидается доставка или подтверждается доставка. Для этого используется параметр ACK.

4) Длина заголовка. Используется для того, чтобы понять какой размер у TCP-заголовка (это все поля представленные на картинке выше, кроме поля данных), а какой у данных.

5) Зарезервированный флаг. Значение этого поля должно устанавливаться в ноль. Оно зарезервировано под специальные нужды. Например, чтобы сообщить о перегрузках в сети.

6) Флаги. В это поле устанавливаются специальные биты для установления или разрыва сессии.

7) Размер окна. Поле, указывающее, на сколько сегментов требовать подтверждения. Наверное, каждый из вас наблюдал такую картину. Вы скачиваете какой-то файл и видите скорость и время скачивания. И тут сначала он показывает, что осталось 30 минут, а через 2-3 секунды уже 20 минут. Еще спустя секунд 5, показывает 10 минут и так далее. Это и есть размер окна. Сначала размер окна устанавливается таким образом, чтобы получать больше подтверждений о каждом отправленном сегменте. Далее все идет хорошо и сеть не сбоит. Размер окна меняется и передается больше сегментов и, соответственно, требуя меньше отчетов о доставке. Таким образом, скачивание выполняется быстрее. Как только сеть даст краткий сбой, и какой то сегмент придет побитым, то размер опять изменится и потребуется больше отчетов о доставке. В этом суть данного поля.

8) Контрольная сумма TCP. Проверка целостности TCP-сегмента.

9) Указатель важности. Это смещение последнего октета важных данных относительно SEQ для пакетов с установленным флагом URG. В жизни применяется, когда необходимо осуществить контроль потока или состояния протокола верхнего уровня со стороны передающего агента (например, если принимающий агент может косвенно сигнализировать передающему, что не справляется с потоком данных).

10) Опции. Используется для каких нибудь расширенных или дополнительных параметров. Например, для параметра timestamp, который является своеобразной меткой, показывающей время произошедшего события.

11) Данные. Практически тоже самое, что и в протоколе UDP. Здесь инкапсулированы данные с вышестоящего уровня.

**Установка сессии:** "трехстороннее рукопожатие". Отправляется TCP сегмент в флагом SYN. Сервер получив сегмент принимает решение, принять ли соед-е. В случ положит ответ, отправляет сегмент с фалогом SYN+ACK, иначе RST. Далее клиент смотрим на ответный сегмент. Если там стоит флаг «SYN+ACK», то клиент в ответ отправляет сегмент с флагом «ACK» и устанавливается соединение. Если же там стоит флаг «RST», то он прекращает попытки соединения. 

Для разрыва установившегося соединения, клиент формирует и отправляет TCP-сегмент с флагом «FIN+ACK». Сервер на этот сегмент отвечает аналогичным флагом «FIN+ACK». И наконец, клиент отправляет последний TCP-сегмент с флагом «ACK». Сейчас вы увидите, как это работает на практике.

## ARP

1) Тип протокола канального уровня (Hardware type). Думаю понятно из названия, что тут указывается тип канального уровня. Мы пока рассматривали только Ethernet. Его обозначение в этом поле — 0x0001.

2) Тип протокола сетевого уровня (Protocol type). Тут, аналогично, указывается тип сетевого уровня. Код IPv4 — 0x0800.

3) Длина физического адреса в байтах (Hardware length). Если это MAC-адрес, то размер будет 6 байт (или 48 бит).

4) Длина логического адреса в байтах (Protocol length). Если это IPv4-адрес, то размер будет 4 байта (или 32 бита).

5) Код операции (Operation). Код операции отправителя. Если это запрос, то код 0001. В случае ответа — 0002.

6) Физический адрес отправителя (Sender hardware address). MAC-адрес отправителя.

7) Логический адрес отправителя (Sender protocol address). IP-адрес отправителя.

8) Физический адрес получателя (Target hardware address). MAC-адрес получателя. Если это запрос, то, как правило, адрес неизвестен и это поле остается пустым.

9) Логический адрес получателя (Target protocol address). IP-адрес получателя.

[Источник](https://m.habr.com/ru/post/308636/)